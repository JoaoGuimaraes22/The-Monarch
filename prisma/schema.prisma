// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Novel {
  id          String   @id @default(cuid())
  title       String
  description String
  coverImage  String?
  wordCount   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  acts        Act[]
  characters  Character[] // ✨ NEW: Characters belong to novels
  povAssignments POVAssignment[]  // ✨ NEW: Flexible POV assignments

  @@map("novels")
}

model Act {
  id        String   @id @default(cuid())
  title     String
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  novelId   String
  novel     Novel     @relation(fields: [novelId], references: [id], onDelete: Cascade)
  chapters  Chapter[]

  @@map("acts")
}

model Chapter {
  id        String   @id @default(cuid())
  title     String
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  actId     String
  act       Act     @relation(fields: [actId], references: [id], onDelete: Cascade)
  scenes    Scene[]

  @@map("chapters")
}

model Scene {
  id        String   @id @default(cuid())
  title     String   @default("")          // ✨ EXISTING: Scene title field
  content   String   @default("")
  wordCount Int      @default(0)
  order     Int
  
  // Metadata
  povCharacter String?                     // ✨ KEEP: Will link to Character later
  sceneType    String   @default("")       // JSON array as string: action, dialogue, introspective
  notes        String   @default("")
  status       String   @default("draft")  // draft, review, complete
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  chapterId String
  chapter   Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@map("scenes")
}

// ===== NEW CHARACTER SYSTEM MODELS =====

model Character {
  id          String   @id @default(cuid())
  
  // Core identity (rarely changes)
  name        String
  titles      String  @default("")
  species     String   @default("Human")
  gender      String?
  imageUrl    String?  // Character portrait
  
  // Origin & background (fixed)
  birthplace  String?  // Will link to Location system later
  family      String?  // JSON as string: parents, siblings, heritage
  
  // Base appearance (permanent features)
  baseAppearance String? // JSON as string: height, eye color, hair color, permanent marks
  
  // Core personality (fundamental traits)
  coreNature  String?  // JSON as string: core traits, deep fears, core values
  
  // Novel relationship
  novelId     String
  novel       Novel    @relation(fields: [novelId], references: [id], onDelete: Cascade)
  
  // Character states (temporal evolution)
  states      CharacterState[]
  
  // Relationships
  relationshipsFrom CharacterRelationship[] @relation("FromCharacter")
  relationshipsTo   CharacterRelationship[] @relation("ToCharacter")
  
  // Character arcs
  characterArcs CharacterArc[]

  povAssignments POVAssignment[] @relation("POVAssignments")
  
  // Meta information
  inspirations String   @default("")  // JSON array as string
  writerNotes  String?
  tags         String   @default("")  // JSON array as string
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([novelId, name]) // Unique character names per novel
  @@map("characters")
}

model POVAssignment {
  id          String @id @default(cuid())
  
  // Novel context
  novelId     String
  novel       Novel  @relation(fields: [novelId], references: [id], onDelete: Cascade)
  
  // Character assignment
  characterId String
  character   Character @relation("POVAssignments", fields: [characterId], references: [id], onDelete: Cascade)
  
  // Flexible scope - same pattern as CharacterState/RelationshipState
  scopeType     String   // "novel" | "act" | "chapter" | "scene"
  startActId    String?
  startChapterId String?
  startSceneId   String?
  endActId       String?
  endChapterId   String?
  endSceneId     String?
  
  // POV metadata
  povType       String @default("primary")    // "primary" | "secondary" | "shared"
  importance    Int    @default(100)          // Weight/priority (100 = primary, 50 = secondary, etc.)
  notes         String?                       // Writer notes about this POV assignment
  
  // Change tracking
  assignedBy    String? // Scene/event that triggered this POV assignment
  reason        String? // Why this character became POV here
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("pov_assignments")
}

model CharacterState {
  id            String @id @default(cuid())
  
  characterId   String
  character     Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  
  // Current circumstances
  age           Int?
  title         String?
  occupation    String?
  location      String?    // Will become locationId later
  socialStatus  String?
  faction       String?    // Will become factionId later
  
  // Evolving personality traits (JSON arrays as strings)
  currentTraits String @default("")  // JSON array as string
  activeFears   String @default("")  // JSON array as string
  currentGoals  String @default("")  // JSON array as string
  motivations   String @default("")  // JSON array as string
  
  // Knowledge & abilities (JSON arrays as strings)
  skills        String @default("")  // JSON array as string
  knowledge     String @default("")  // JSON array as string
  secrets       String @default("")  // JSON array as string
  
  // Physical appearance changes
  currentAppearance String? // JSON as string: clothing, scars, temporary marks
  
  // Mental/emotional state
  mentalState   String?
  
  // Scope - where this state applies in the story
  scopeType     String   // "novel" | "act" | "chapter" | "scene"
  startActId    String?
  startChapterId String?
  startSceneId   String?
  endActId       String?
  endChapterId   String?
  endSceneId     String?
  
  // Change tracking
  changes       String?  // JSON as string: what changed and why
  triggerSceneId String? // Scene that caused this change
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("character_states")
}

model CharacterRelationship {
  id              String @id @default(cuid())
  
  fromCharacterId String
  fromCharacter   Character @relation("FromCharacter", fields: [fromCharacterId], references: [id], onDelete: Cascade)
  
  toCharacterId   String
  toCharacter     Character @relation("ToCharacter", fields: [toCharacterId], references: [id], onDelete: Cascade)
  
  // STATIC foundation (never changes) - KEEP THESE
  baseType        String   // "family" | "romantic" | "professional" | "antagonistic" | "mentor_student" | "friendship"
  origin          String?  // "Childhood friends who became engaged"
  history         String?  // Background of the relationship
  fundamentalDynamic String? // Core pattern that doesn't change
  
  
  // NEW: Temporal evolution
  relationshipStates RelationshipState[]
  
  // Meta - KEEP
  writerNotes     String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([fromCharacterId, toCharacterId])
  @@map("character_relationships")
}


model RelationshipState {
  id              String @id @default(cuid())
  
  relationshipId  String
  relationship    CharacterRelationship @relation(fields: [relationshipId], references: [id], onDelete: Cascade)
  
  // EVOLVING relationship state (changes over time)
  currentType     String   // "ally" | "enemy" | "romantic" | "neutral" | "complicated" | "mentor" | "rival" | "family"
  subtype         String?  // "bitter enemies" | "secret lovers" | "estranged siblings"
  strength        Int @default(5) // 1-10 intensity
  
  // Status (public vs private)
  publicStatus    String?  // How they appear in public
  privateStatus   String?  // True nature of relationship
  
  // Emotional dynamics
  trustLevel      Int @default(5)    // 1-10
  conflictLevel   Int @default(1)    // 1-10
  powerBalance    String @default("equal") // "equal" | "a_dominant" | "b_dominant" | "shifting"
  
  // Temporal scope (same as CharacterState)
  scopeType       String   // "novel" | "act" | "chapter" | "scene"
  startActId      String?
  startChapterId  String?
  startSceneId    String?
  endActId        String?
  endChapterId    String?
  endSceneId      String?
  
  // Change tracking
  changes         String?  // JSON as string: what changed and why
  triggerSceneId  String? // Scene that caused this change
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("relationship_states")
}


model CharacterArc {
  id          String @id @default(cuid())
  
  characterId String
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  
  // Arc definition
  title       String   // "Lyra's Journey from Vengeance to Justice"
  description String?  // Detailed arc description
  archetype   String?  // "Hero's Journey" | "Redemption Arc" | "Fall from Grace"
  
  // Arc scope - can be novel-wide, act-specific, or chapter-specific
  scopeType   String   // "novel" | "act" | "chapter"
  targetId    String   // Novel, Act, or Chapter ID
  
  // Arc progression
  startPoint  String?  // Character state at beginning
  endPoint    String?  // Character state at end
  keyMoments  String?  // JSON as string: array of {sceneId, description, type, notes}
  
  // Progress tracking
  currentStage String?
  completion   Int @default(0) // 0-100%
  
  // Meta
  writerNotes String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("character_arcs")
}

